@using Newtonsoft.Json.Linq

@inject OrchardCore.ContentManagement.Display.IContentItemDisplayManager ContentItemDisplayManager
@inject OrchardCore.DisplayManagement.ModelBinding.IUpdateModelAccessor ModelUpdaterAccessor

@{
    ContentItem contentItem = Model.ContentItem;
    JArray termsArray = contentItem.Content.Terms;
    var index = 0;
}

<li class="menu-item list-group-item" id="menu-id-@Model.Index" data-index="@Model.Index">
    <div class="menu-item menu-item-title border rounded p-2 ps-3 mb-1 d-flex flex-row justify-content-between align-items-center">
        <div>
            <span>@contentItem</span>

            @if (!contentItem.IsPublished())
            {
                <span class="badge font-weight-normal bg-warning text-white" data-bs-toggle="tooltip" title="@T["Status"]">
                    <i class="fas fa-file-invoice me-1" aria-hidden="true"></i>@T["Not Published"]
                </span>
            }
            else
            {
                <span class="badge font-weight-normal bg-success text-white" data-bs-toggle="tooltip" title="@T["Status"]">
                    <i class="fas fa-file-invoice me-1" aria-hidden="true"></i>@T["Published"]
                </span>
            }
        </div>
        @if (Model.Content != null)
        {
            @await DisplayAsync(Model.Content)
        }
        <div class="float-end">
            <a asp-action="Edit"
               asp-controller="Admin"
               asp-route-area="OrchardCore.Taxonomies"
               asp-route-taxonomyContentItemId="@Model.TaxonomyPart.ContentItem.ContentItemId"
               asp-route-taxonomyItemId="@Model.ContentItem.ContentItemId"
               asp-route-returnUrl="@FullRequestPath"
               class="btn btn-success btn-sm">
                @T["Edit"]
            </a>
            <a class="btn btn-primary btn-sm"
               asp-route-action="Create"
               asp-route-controller="Admin"
               asp-route-id="@Model.TaxonomyPart.TermContentType"
               asp-route-taxonomyContentItemId="@Model.TaxonomyPart.ContentItem.ContentItemId"
               asp-route-taxonomyItemId="@Model.ContentItem.ContentItemId"
               asp-route-returnUrl="@FullRequestPath"
               asp-route-area="OrchardCore.Taxonomies">
                @T["Add"]
            </a>
            <a asp-action="Delete"
               asp-controller="Admin"
               asp-route-area="OrchardCore.Taxonomies"
               asp-route-taxonomyContentItemId="@Model.TaxonomyPart.ContentItem.ContentItemId"
               asp-route-taxonomyItemId="@Model.ContentItem.ContentItemId"
               asp-route-returnUrl="@FullRequestPath"
               data-url-af="RemoveUrl UnsafeUrl"
               class="btn btn-danger btn-sm">
                @T["Delete"]
            </a>
        </div>
    </div>

    @if (termsArray != null)
    {
        var updater = ModelUpdaterAccessor.ModelUpdater;

        <ol class="menu-item menu-item-links">
            @foreach (JObject termObject in termsArray)
            {
                var term = termObject.ToObject<ContentItem>();
                dynamic termShape = await ContentItemDisplayManager.BuildDisplayAsync(term, updater, "TermAdmin");
                termShape.TaxonomyPart = Model.TaxonomyPart;
                termShape.Index = Model.Index + "-" + index++;
                @await DisplayAsync(termShape)
            }
        </ol>
    }

</li>
